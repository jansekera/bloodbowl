var Q=Object.defineProperty;var Z=(s,e,t)=>e in s?Q(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var u=(s,e,t)=>Z(s,typeof e!="symbol"?e+"":e,t);import{P as J,S as ee,T as te,G as se}from"./ScoreBoard.js";const ae="/api/v1";class ne{constructor(e=ae){u(this,"baseUrl");this.baseUrl=e}async getRaces(){return(await this.get("/races")).data}async getRace(e){return(await this.get(`/races/${e}`)).data}async getTeams(){return(await this.get("/teams")).data}async getTeam(e){return(await this.get(`/teams/${e}`)).data}async getMatchState(e){return(await this.get(`/matches/${e}/state`)).data}async submitAction(e,t,n={}){const r=await this.post(`/matches/${e}/actions`,{action:t,params:n});return{...r.data,state:r.state}}async getValidMoves(e,t){return(await this.get(`/matches/${e}/players/${t}/moves`)).data}async getBlockTargets(e,t){return(await this.get(`/matches/${e}/players/${t}/block-targets`)).data}async getPassTargets(e,t){return(await this.get(`/matches/${e}/players/${t}/pass-targets`)).data}async getFoulTargets(e,t){return(await this.get(`/matches/${e}/players/${t}/foul-targets`)).data}async getHandOffTargets(e,t){return(await this.get(`/matches/${e}/players/${t}/handoff-targets`)).data}async getAllEvents(e){return(await this.get(`/matches/${e}/events?all=1`)).data}async getAvailableSkills(e){return(await this.get(`/players/${e}/available-skills`)).data}async advancePlayer(e,t){return this.post(`/players/${e}/advance`,{skill_id:t})}async getAvailableActions(e){return(await this.get(`/matches/${e}/actions`)).data}async get(e){var n;const t=await fetch(`${this.baseUrl}${e}`,{headers:{Accept:"application/json"}});if(!t.ok){const r=await t.json().catch(()=>({}));throw new G(r.error??((n=r.errors)==null?void 0:n[0])??`HTTP ${t.status}`,t.status)}return t.json()}async post(e,t){var r;const n=await fetch(`${this.baseUrl}${e}`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify(t)});if(!n.ok){const a=await n.json().catch(()=>({}));throw new G(a.error??((r=a.errors)==null?void 0:r[0])??`HTTP ${n.status}`,n.status)}return n.json()}}class G extends Error{constructor(e,t){super(e),this.statusCode=t,this.name="ApiClientError"}}function O(s){return s<.5?4*s*s*s:1-Math.pow(-2*s+2,3)/2}function $(s,e,t){return s+(e-s)*t}function re(){return{playerOverrides:new Map,ballOverride:null,flashCell:null,shakePlayer:null}}function q(s,e,t,n,r,a=200){const i=r(t),l=r(n);return{duration:a,start(){s.playerOverrides.set(e,i)},update(h){const o=O(h);s.playerOverrides.set(e,{px:$(i.px,l.px,o),py:$(i.py,l.py,o)})},finish(){s.playerOverrides.delete(e)}}}function P(s,e,t=4,n=300){return{duration:n,start(){s.shakePlayer={playerId:e,offsetX:0,offsetY:0}},update(r){const a=1-r,i=r*20;s.shakePlayer={playerId:e,offsetX:Math.sin(i)*t*a,offsetY:Math.cos(i*1.3)*t*a}},finish(){s.shakePlayer=null}}}function B(s,e,t,n,r=40,a=500){const i=n(e),l=n(t);return{duration:a,start(){s.ballOverride=i},update(h){const o=O(h),d=Math.sin(o*Math.PI)*r;s.ballOverride={px:$(i.px,l.px,o),py:$(i.py,l.py,o)-d}},finish(){s.ballOverride=null}}}function ie(s,e,t,n,r=150){const a=n(e),i=n(t);return{duration:r,start(){s.ballOverride=a},update(l){const h=O(l),o=Math.abs(Math.sin(h*Math.PI))*10;s.ballOverride={px:$(a.px,i.px,h),py:$(a.py,i.py,h)-o}},finish(){s.ballOverride=null}}}function D(s,e,t,n=400){return{duration:n,update(r){const a=Math.max(0,1-r);s.flashCell={pos:e,color:t.replace(/[\d.]+\)$/,`${a})`)}},finish(){s.flashCell=null}}}function L(s=100){return{duration:s,update(){}}}class le{constructor(e,t){u(this,"queue",[]);u(this,"current",null);u(this,"startTime",0);u(this,"animFrameId",0);u(this,"resolvePromise",null);u(this,"_isAnimating",!1);u(this,"state");u(this,"tick",()=>{if(!this.current)return;const e=performance.now()-this.startTime,t=Math.min(1,e/this.current.duration);this.current.update(t),this.renderCallback(),t<1?this.animFrameId=requestAnimationFrame(this.tick):(this.current.finish&&this.current.finish(),this.animFrameId=0,this.playNext())});this.renderCallback=e,this.gridToPixel=t,this.state=re()}get isAnimating(){return this._isAnimating}async playEvents(e){const t=this.eventsToAnimations(e);if(t.length!==0)return this.queue=t,this._isAnimating=!0,new Promise(n=>{this.resolvePromise=n,this.playNext()})}skip(){var e;this.animFrameId&&(cancelAnimationFrame(this.animFrameId),this.animFrameId=0),(e=this.current)!=null&&e.finish&&this.current.finish();for(const t of this.queue)t.finish&&t.finish();this.queue=[],this.current=null,this._isAnimating=!1,this.renderCallback(),this.resolvePromise&&(this.resolvePromise(),this.resolvePromise=null)}playNext(){if(this.queue.length===0){this.current=null,this._isAnimating=!1,this.renderCallback(),this.resolvePromise&&(this.resolvePromise(),this.resolvePromise=null);return}this.current=this.queue.shift(),this.current.start&&this.current.start(),this.startTime=performance.now(),this.tick()}eventsToAnimations(e){const t=[];for(const n of e){const r=n.data;switch(n.type){case"player_move":{const a=this.parsePosition(r.from),i=this.parsePosition(r.to);a&&i&&t.push(q(this.state,r.playerId,a,i,this.gridToPixel,150));break}case"block":{const a=r.targetId;a&&t.push(P(this.state,a,4,250));break}case"push":{const a=this.parsePosition(r.from),i=this.parsePosition(r.to),l=r.playerId;a&&i&&l&&t.push(q(this.state,l,a,i,this.gridToPixel,200));break}case"pass":{const a=this.parsePosition(r.from),i=this.parsePosition(r.to);a&&i&&t.push(B(this.state,a,i,this.gridToPixel,40,400));break}case"ball_bounce":{const a=this.parsePosition(r.from),i=this.parsePosition(r.to);a&&i&&t.push(ie(this.state,a,i,this.gridToPixel,120));break}case"kickoff":{const a=this.parsePosition(r.kickTo),i=this.parsePosition(r.landedAt);a&&i&&t.push(B(this.state,{x:13,y:7},i,this.gridToPixel,60,600));break}case"player_fell":case"crowd_surf":{if(r.playerId){const i=this.parsePosition(r.position);i&&t.push(D(this.state,i,"rgba(255, 0, 0, 1)",350))}break}case"touchdown":{t.push(L(500));break}case"turnover":{t.push(L(300));break}case"wrestle":{const a=r.attackerId,i=r.defenderId;a&&t.push(P(this.state,a,3,200)),i&&t.push(P(this.state,i,3,200));break}case"leap":{const a=r.playerId,i=r.success;if(a){const l=i?"rgba(0, 200, 255, 1)":"rgba(255, 0, 0, 1)";t.push(D(this.state,{x:0,y:0},l,300))}break}case"throw_team_mate":{const a=this.parsePosition(r.from),i=this.parsePosition(r.to);a&&i&&t.push(B(this.state,a,i,this.gridToPixel,60,600));break}case"tentacles":{const a=r.tentaclesPlayerId;a&&t.push(P(this.state,a,3,250));break}case"bone_head":case"really_stupid":case"wild_animal":{const a=r.playerId,i=r.success;a&&!i&&t.push(P(this.state,a,2,300));break}case"fend":{const a=r.playerId;a&&t.push(P(this.state,a,2,200));break}case"piling_on":{const a=r.attackerId;a&&t.push(P(this.state,a,3,250));break}case"dump_off":case"hail_mary_pass":{t.push(L(200));break}case"secret_weapon":case"take_root":{t.push(L(150));break}}}return t}parsePosition(e){if(!e||typeof e!="string")return null;const t=e.split(",");if(t.length!==2)return null;const n=parseInt(t[0],10),r=parseInt(t[1],10);return isNaN(n)||isNaN(r)?null:{x:n,y:r}}}class oe{constructor(e,t){u(this,"container");u(this,"onAction");u(this,"selectedMode",null);u(this,"_firstTargetSelected",!1);this.container=e,this.container.classList.add("action-panel"),this.onAction=t}getSelectedMode(){return this.selectedMode}setSelectedMode(e){this.selectedMode=e,this._firstTargetSelected=!1}setFirstTargetSelected(e){this._firstTargetSelected=e}update(e,t){if(!e){this.container.innerHTML="";return}const n=e.activeTeam==="home"?e.homeTeam:e.awayTeam,r=e.phase;let a='<div class="action-panel__info">';if(a+=`<span class="action-panel__phase">${this.formatPhase(r)}</span>`,r==="game_over"){const i=e.homeTeam.score,l=e.awayTeam.score,h=i>l?e.homeTeam.name:l>i?e.awayTeam.name:null;a+=`<span class="action-panel__score">${e.homeTeam.name} ${i} - ${l} ${e.awayTeam.name}</span>`,a+=`<span class="action-panel__winner">${h?`${h} wins!`:"Draw!"}</span>`}else a+=`<span class="action-panel__turn">Turn ${n.turnNumber}/8</span>`,a+=`<span class="action-panel__rerolls">Rerolls: ${n.rerolls}</span>`,a+=`<span class="action-panel__team">${n.name}'s turn</span>`;if(a+="</div>",r==="touchdown"&&(a+='<div class="action-panel__message action-panel__message--touchdown">TOUCHDOWN!</div>'),t){if(a+='<div class="action-panel__buttons">',r==="play"){const i=this.selectedMode==="block"?" btn--active":"",l=this.selectedMode==="multiple_block"?" btn--active":"",h=this.selectedMode==="blitz"?" btn--active":"",o=this.selectedMode==="pass"?" btn--active":"",d=this.selectedMode==="handoff"?" btn--active":"",m=this.selectedMode==="foul"?" btn--active":"",x=n.blitzUsedThisTurn?" disabled":"",W=n.passUsedThisTurn?" disabled":"",K=n.foulUsedThisTurn?" disabled":"";a+=`<button class="btn btn--small btn--secondary${i}" data-action="toggle_block">Block</button>`,a+=`<button class="btn btn--small btn--secondary${l}" data-action="toggle_multiple_block">Multi Block</button>`,a+=`<button class="btn btn--small btn--secondary${h}" data-action="toggle_blitz"${x}>Blitz</button>`,a+=`<button class="btn btn--small btn--secondary${o}" data-action="toggle_pass"${W}>Pass</button>`,a+=`<button class="btn btn--small btn--secondary${d}" data-action="toggle_handoff">Hand-off</button>`,a+=`<button class="btn btn--small btn--secondary${m}" data-action="toggle_foul"${K}>Foul</button>`,a+='<button class="btn btn--small btn--danger" data-action="end_turn">End Turn</button>'}if(r==="setup"&&(a+='<button class="btn btn--small btn--primary" data-action="end_setup">Done Setup</button>'),a+="</div>",this.selectedMode){const i=this.getHintText(this.selectedMode);a+=`<div class="action-panel__hint">${i}</div>`}}this.container.innerHTML=a,this.container.querySelectorAll("[data-action]").forEach(i=>{i.addEventListener("click",()=>{const l=i.dataset.action;l&&this.onAction(l)})})}getHintText(e){switch(e){case"block":return"Click an enemy player to block";case"multiple_block":return this._firstTargetSelected?"Select second target to block":"Select first target to block";case"blitz":return"Click an enemy player to blitz";case"pass":return"Select your ball carrier, then click a target square";case"handoff":return"Select your ball carrier, then click an adjacent teammate";case"foul":return"Click your player, then click an adjacent prone/stunned enemy";default:return`Click to ${e}`}}formatPhase(e){switch(e){case"setup":return"Setup";case"play":return"Playing";case"kickoff":return"Kickoff";case"touchdown":return"Touchdown!";case"half_time":return"Half Time";case"game_over":return"Game Over";default:return e}}}class ce{constructor(e){u(this,"container");u(this,"events",[]);this.container=e,this.container.classList.add("game-log"),this.render()}addEvent(e){this.events.unshift(e),this.events.length>50&&(this.events=this.events.slice(0,50)),this.render()}addEvents(e){for(const t of e)this.events.unshift(t);this.events.length>50&&(this.events=this.events.slice(0,50)),this.render()}clear(){this.events=[],this.render()}render(){if(this.events.length===0){this.container.innerHTML='<div class="game-log__empty">No events yet</div>';return}this.container.innerHTML="<h3>Game Log</h3>"+this.events.map(e=>this.renderEvent(e)).join("")}renderEvent(e){return`<div class="game-log__event game-log__event--${this.getEventClass(e.type)}">${this.escapeHtml(e.description)}</div>`}getEventClass(e){switch(e){case"turnover":return"turnover";case"dodge":return"roll";case"gfi":return"roll";case"block":return"block";case"armour_roll":return"roll";case"injury_roll":return"injury";case"player_fell":return"injury";case"push":return"block";case"crowd_surf":return"injury";case"follow_up":return"default";case"end_turn":return"phase";case"ball_pickup":return"ball";case"ball_bounce":return"ball";case"pass":return"ball";case"catch":return"ball";case"hand_off":return"ball";case"interception":return"ball";case"throw_in":return"ball";case"touchdown":return"touchdown";case"kickoff":return"phase";case"touchback":return"phase";case"half_time":return"phase";case"game_over":return"phase";case"ko_recovery":return"roll";case"bone_head":return"roll";case"really_stupid":return"roll";case"wild_animal":return"roll";case"loner":return"roll";case"regeneration":return"roll";case"pro":return"roll";case"foul":return"block";case"ejection":return"injury";case"reroll":return"roll";case"apothecary":return"roll";case"weather_change":return"phase";case"sweltering_heat":return"injury";case"kickoff_table":return"phase";case"stand_up":return"default";case"strip_ball":return"ball";case"frenzy":return"block";case"pickup":return"ball";case"player_move":return"default";case"wrestle":return"block";case"tentacles":return"roll";case"juggernaut":return"block";case"diving_tackle":return"roll";case"leap":return"roll";case"throw_team_mate":return"ball";case"ttm_landing":return"roll";case"multiple_block":return"block";default:return"default"}}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}}class de{constructor(e,t){u(this,"container");u(this,"onSelect");u(this,"selectedPlayerId",null);this.container=e,this.container.classList.add("reserves-panel"),this.onSelect=t}setSelectedPlayer(e){this.selectedPlayerId=e,this.highlightSelected()}update(e,t){if(!e||e.phase!=="setup"){this.container.style.display="none";return}this.container.style.display="";const n=e.activeTeam,r=e.players.filter(l=>l.teamSide===n&&l.position===null),a=e.players.filter(l=>l.teamSide===n&&l.position!==null).length;let i=`<h3 class="reserves-panel__title">Reserves (${r.length})</h3>`;if(i+=`<div class="reserves-panel__count">${a}/11 placed</div>`,r.length===0)i+='<div class="reserves-panel__empty">All players placed</div>';else{i+='<div class="reserves-panel__list">';for(const l of r){const h=l.id===this.selectedPlayerId?" reserves-player--selected":"";i+=this.renderPlayer(l,h,t)}i+="</div>"}this.container.innerHTML=i,t&&this.container.querySelectorAll("[data-player-id]").forEach(l=>{l.addEventListener("click",()=>{const h=parseInt(l.dataset.playerId??"0",10);h&&this.onSelect(h)})})}renderPlayer(e,t,n){const r=n?" reserves-player--interactive":"",a=e.stats;return`<div class="reserves-player${t}${r}" data-player-id="${e.id}">
            <span class="reserves-player__number">#${e.number}</span>
            <span class="reserves-player__name">${e.name}</span>
            <span class="reserves-player__pos">${e.positionalName}</span>
            <span class="reserves-player__stats">${a.movement}/${a.strength}/${a.agility}/${a.armour}</span>
        </div>`}highlightSelected(){this.container.querySelectorAll(".reserves-player").forEach(e=>{const t=parseInt(e.dataset.playerId??"0",10);e.classList.toggle("reserves-player--selected",t===this.selectedPlayerId)})}}class ue{constructor(e){u(this,"container");u(this,"events",[]);u(this,"currentIndex",-1);u(this,"isPlaying",!1);u(this,"speed",1);u(this,"playTimer",null);u(this,"onStep",null);this.container=e,this.container.classList.add("replay-controls")}setEvents(e){this.events=e,this.currentIndex=-1,this.isPlaying=!1,this.render()}setOnStep(e){this.onStep=e}getEventCount(){return this.events.length}getCurrentIndex(){return this.currentIndex}isActive(){return this.isPlaying}next(){var t;if(this.currentIndex>=this.events.length-1)return this.pause(),null;this.currentIndex++;const e=this.events[this.currentIndex];return(t=this.onStep)==null||t.call(this,e),this.render(),e}prev(){if(this.currentIndex<=0)return null;this.currentIndex--;const e=this.events[this.currentIndex];return this.render(),e}play(){this.isPlaying||(this.isPlaying=!0,this.playTimer=setInterval(()=>{this.next()||this.pause()},1e3/this.speed),this.render())}pause(){this.isPlaying=!1,this.playTimer&&(clearInterval(this.playTimer),this.playTimer=null),this.render()}cycleSpeed(){this.speed===1?this.speed=2:this.speed===2?this.speed=4:this.speed=1,this.isPlaying?(this.pause(),this.play()):this.render()}render(){const e=this.events.length,t=this.currentIndex+1,n=this.currentIndex>=0&&this.currentIndex<this.events.length?this.events[this.currentIndex].description:"";this.container.innerHTML=`
            <div class="replay-controls__bar">
                <button class="btn btn--small" data-replay="prev" title="Previous event">&#9198;</button>
                <button class="btn btn--small" data-replay="${this.isPlaying?"pause":"play"}" title="${this.isPlaying?"Pause":"Play"}">
                    ${this.isPlaying?"&#9208;":"&#9654;"}
                </button>
                <button class="btn btn--small" data-replay="next" title="Next event">&#9197;</button>
                <button class="btn btn--small" data-replay="speed" title="Change speed">${this.speed}Ã—</button>
                <span class="replay-controls__counter">Event ${t} / ${e}</span>
            </div>
            ${n?`<div class="replay-controls__desc">${n}</div>`:""}
        `,this.container.querySelectorAll("[data-replay]").forEach(r=>{r.addEventListener("click",()=>{switch(r.dataset.replay){case"prev":this.prev();break;case"next":this.next();break;case"play":this.play();break;case"pause":this.pause();break;case"speed":this.cycleSpeed();break}})})}destroy(){this.pause(),this.container.innerHTML=""}}class he{constructor(e){u(this,"overlay");this.container=e,this.overlay=document.createElement("div"),this.overlay.className="match-summary-overlay",this.overlay.style.display="none",this.container.appendChild(this.overlay),this.overlay.addEventListener("click",t=>{t.target===this.overlay&&this.hide()})}show(e){const t=e.homeScore>e.awayScore?e.homeTeamName:e.awayScore>e.homeScore?e.awayTeamName:null,n=t?`${t} wins!`:"Draw!";this.overlay.innerHTML=`
            <div class="match-summary">
                <h2 class="match-summary__title">Match Over</h2>
                <div class="match-summary__result">${n}</div>
                <div class="match-summary__score">
                    <div class="match-summary__team">
                        <span class="match-summary__team-name">${e.homeTeamName}</span>
                        <span class="match-summary__team-score">${e.homeScore}</span>
                    </div>
                    <span class="match-summary__vs">-</span>
                    <div class="match-summary__team">
                        <span class="match-summary__team-score">${e.awayScore}</span>
                        <span class="match-summary__team-name">${e.awayTeamName}</span>
                    </div>
                </div>
                ${e.mvp?`<div class="match-summary__mvp">MVP: ${e.mvp.name} (${e.mvp.team})</div>`:""}
                <button class="match-summary__close">Close</button>
            </div>
        `,this.overlay.style.display="flex";const r=this.overlay.querySelector(".match-summary__close");r==null||r.addEventListener("click",()=>this.hide())}hide(){this.overlay.style.display="none"}destroy(){this.overlay.remove()}}function pe(s){return{homeTeamName:s.homeTeam.name,awayTeamName:s.awayTeam.name,homeScore:s.homeTeam.score,awayScore:s.awayTeam.score,homeTouchdowns:[],awayTouchdowns:[],mvp:null}}class me{constructor(e){u(this,"banner");u(this,"timeout",null);this.container=e,this.banner=document.createElement("div"),this.banner.className="phase-banner",this.banner.style.display="none",this.container.appendChild(this.banner)}show(e,t=2e3){return this.banner.textContent=e,this.banner.style.display="flex",new Promise(n=>{this.timeout=setTimeout(()=>{this.banner.style.display="none",this.timeout=null,n()},t)})}hide(){this.timeout&&(clearTimeout(this.timeout),this.timeout=null),this.banner.style.display="none"}destroy(){this.hide(),this.banner.remove()}}class ye{constructor(e){u(this,"container");this.container=document.createElement("div"),this.container.className="toast-container",e.appendChild(this.container)}show(e){const{message:t,level:n="info",duration:r=3e3}=e,a=document.createElement("div");a.className=`toast toast--${n}`,a.textContent=t,this.container.appendChild(a),setTimeout(()=>{a.classList.add("toast--fading"),setTimeout(()=>a.remove(),300)},r)}info(e){this.show({message:e,level:"info"})}error(e){this.show({message:e,level:"error"})}success(e){this.show({message:e,level:"success"})}destroy(){this.container.remove()}}class fe{constructor(e){u(this,"container");u(this,"onSelect",null);u(this,"onSkip",null);this.container=e,this.container.classList.add("level-up-modal"),this.container.style.display="none"}show(e,t,n,r){this.onSelect=n,this.onSkip=r,this.container.style.display="",this.render(e,t)}hide(){this.container.style.display="none",this.container.innerHTML="",this.onSelect=null,this.onSkip=null}render(e,t){const n=t.normal.length>0?'<h4>Normal Skills</h4><div class="level-up-modal__skills">'+t.normal.map(l=>this.renderSkill(l,"normal")).join("")+"</div>":"",r=t.double.length>0?'<h4>Double Skills</h4><div class="level-up-modal__skills">'+t.double.map(l=>this.renderSkill(l,"double")).join("")+"</div>":"";this.container.innerHTML=`<div class="level-up-modal__backdrop"></div><div class="level-up-modal__content"><h3>Level Up: ${this.escapeHtml(e)}</h3>`+n+r+'<div class="level-up-modal__actions"><button class="level-up-modal__skip">Skip</button></div></div>',this.container.querySelectorAll("[data-skill-id]").forEach(l=>{l.addEventListener("click",()=>{var o;const h=parseInt(l.dataset.skillId,10);(o=this.onSelect)==null||o.call(this,h),this.hide()})});const a=this.container.querySelector(".level-up-modal__skip");a==null||a.addEventListener("click",()=>{var l;(l=this.onSkip)==null||l.call(this),this.hide()});const i=this.container.querySelector(".level-up-modal__backdrop");i==null||i.addEventListener("click",()=>{var l;(l=this.onSkip)==null||l.call(this),this.hide()})}renderSkill(e,t){return`<button class="level-up-modal__skill level-up-modal__skill--${t}" data-skill-id="${e.id}">${this.escapeHtml(e.name)}</button>`}escapeHtml(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}}const y=new ne,T=document.querySelector(".match-container"),f=parseInt((T==null?void 0:T.dataset.matchId)??"0",10);if(!f)throw new Error("No match ID found");const S=document.getElementById("pitch-canvas"),g=new J(S,32),c=new se,ve=document.getElementById("scoreboard"),ge=new ee(ve),be=document.getElementById("game-log"),F=new ce(be),_e=document.getElementById("action-panel"),v=new oe(_e,Y),ke=document.getElementById("reserves-panel"),j=new de(ke,Ce),V=document.getElementById("replay-controls"),R=new ue(V),we=document.getElementById("tooltip"),H=new te(we.parentElement),Pe=new he(T),z=new me(T),b=new ye(T),X=document.createElement("div");T.appendChild(X);const Te=new fe(X),C=new le(()=>Se(),s=>g.geometry.gridToPixel(s));g.setAnimationState(C.state);function Se(){const s=c.getGameState();if(!s)return;const e=c.getSelection(),t=e.mode==="move"&&w.length>0;if(g.render(s.players,s.ball,t?[]:e.validTargets,e.selectedPlayerId,e.hoveredCell),t&&g.drawRiskHighlights(w),s.phase==="setup"&&g.drawSetupZone(s.activeTeam),s.ball.isHeld&&s.ball.carrierId){const n=s.players.find(r=>r.id===s.ball.carrierId);n!=null&&n.position&&g.drawBallOnPlayer(n.position)}if(e.firstTargetId!==null){const n=s.players.find(r=>r.id===e.firstTargetId);n!=null&&n.position&&g.drawSelectedTarget(n.position)}}let U="";async function I(s){var t;await C.playEvents(s.events),F.addEvents(s.events);const e=s.state.phase;if(e!==U){if(e==="half_time")await z.show("HALF TIME",1500);else if(e==="touchdown"){const n=s.events.find(a=>a.type==="touchdown"),r=((t=n==null?void 0:n.data)==null?void 0:t.playerName)??"";await z.show(r?`TOUCHDOWN! ${r}`:"TOUCHDOWN!",1500)}else e==="game_over"&&Pe.show(pe(s.state));U=e}c.setGameState(s.state)}let w=[],_=[],A=[],M=[],E=[],N=null,p=!1;S.addEventListener("dblclick",()=>{C.isAnimating&&C.skip()});c.onChange(()=>{const s=c.getGameState();if(!s)return;const e=c.getSelection(),t=e.mode==="move"&&w.length>0;if(g.render(s.players,s.ball,t?[]:e.validTargets,e.selectedPlayerId,e.hoveredCell),t&&g.drawRiskHighlights(w),s.phase==="setup"&&g.drawSetupZone(s.activeTeam),s.ball.isHeld&&s.ball.carrierId){const n=s.players.find(r=>r.id===s.ball.carrierId);n!=null&&n.position&&g.drawBallOnPlayer(n.position)}if(e.firstTargetId!==null){const n=s.players.find(r=>r.id===e.firstTargetId);n!=null&&n.position&&g.drawSelectedTarget(n.position)}ge.update(s),v.update(s,c.isPlayerTurn()),j.update(s,c.isPlayerTurn())});S.addEventListener("click",async s=>{if(p)return;const e=c.getGameState();if(!e)return;const t=S.getBoundingClientRect(),n=s.clientX-t.left,r=s.clientY-t.top,a=g.geometry.pixelToGrid(n,r);if(!a)return;const i=c.getSelection(),l=v.getSelectedMode();if(e.phase==="setup"&&N!==null&&c.isPlayerTurn()){await Le(N,a.x,a.y);return}if(l==="multiple_block"){if(i.selectedPlayerId){const d=_.find(m=>m.x===a.x&&m.y===a.y);if(d)if(i.firstTargetId===null){const m=_.filter(x=>x.playerId!==d.playerId);c.setFirstTarget(d.playerId,m.map(x=>({x:x.x,y:x.y}))),v.setFirstTargetSelected(!0),v.update(e,c.isPlayerTurn());return}else{await $e(i.selectedPlayerId,i.firstTargetId,d.playerId);return}}const o=c.getPlayerAtPosition(a);if(o&&o.teamSide===e.activeTeam&&c.isPlayerTurn()&&o.state==="standing"&&!o.hasActed&&o.skills.includes("Multiple Block")){c.selectPlayer(o.id);try{_=await y.getBlockTargets(f,o.id),_.length>=2?c.setValidTargets("multiple_block",_.map(d=>({x:d.x,y:d.y}))):(_=[],b.error("Need 2+ adjacent enemies for Multiple Block"))}catch{_=[]}}return}if(l==="block"||l==="blitz"){if(i.selectedPlayerId){const d=_.find(m=>m.x===a.x&&m.y===a.y);if(d){await xe(i.selectedPlayerId,d.playerId,l);return}}const o=c.getPlayerAtPosition(a);if(o&&o.teamSide===e.activeTeam&&c.isPlayerTurn()&&o.state==="standing"&&!o.hasActed){c.selectPlayer(o.id);try{_=await y.getBlockTargets(f,o.id),c.setValidTargets(l==="block"?"block":"blitz",_.map(d=>({x:d.x,y:d.y})))}catch{_=[]}}return}if(l==="pass"){if(i.selectedPlayerId&&A.find(m=>m.x===a.x&&m.y===a.y)){await Ae(i.selectedPlayerId,a.x,a.y);return}const o=c.getPlayerAtPosition(a);if(o&&o.teamSide===e.activeTeam&&c.isPlayerTurn()&&o.state==="standing"&&!o.hasActed&&e.ball.carrierId===o.id){c.selectPlayer(o.id);try{A=await y.getPassTargets(f,o.id),c.setValidTargets("pass",A.map(d=>({x:d.x,y:d.y})))}catch{A=[]}}return}if(l==="handoff"){if(i.selectedPlayerId){const d=M.find(m=>m.x===a.x&&m.y===a.y);if(d){await Me(i.selectedPlayerId,d.playerId);return}}const o=c.getPlayerAtPosition(a);if(o&&o.teamSide===e.activeTeam&&c.isPlayerTurn()&&o.state==="standing"&&!o.hasActed&&e.ball.carrierId===o.id){c.selectPlayer(o.id);try{M=await y.getHandOffTargets(f,o.id),c.setValidTargets("handoff",M.map(d=>({x:d.x,y:d.y})))}catch{M=[]}}return}if(l==="foul"){if(i.selectedPlayerId){const d=E.find(m=>m.x===a.x&&m.y===a.y);if(d){await Ee(i.selectedPlayerId,d.playerId);return}}const o=c.getPlayerAtPosition(a);if(o&&o.teamSide===e.activeTeam&&c.isPlayerTurn()&&o.state==="standing"&&!o.hasActed){c.selectPlayer(o.id);try{E=await y.getFoulTargets(f,o.id),c.setValidTargets("foul",E.map(d=>({x:d.x,y:d.y})))}catch{E=[]}}return}if(i.selectedPlayerId&&i.mode==="move"&&w.some(d=>d.x===a.x&&d.y===a.y)){await Ie(i.selectedPlayerId,a.x,a.y);return}const h=c.getPlayerAtPosition(a);if(h&&h.teamSide===e.activeTeam&&c.isPlayerTurn()){if(c.selectPlayer(h.id),!h.hasMoved&&(h.state==="standing"||h.state==="prone"))try{w=await y.getValidMoves(f,h.id),c.setValidTargets("move",w.map(o=>({x:o.x,y:o.y})))}catch{w=[]}}else c.clearSelection(),k(),c.setGameState(e)});S.addEventListener("mousemove",s=>{const e=S.getBoundingClientRect(),t=s.clientX-e.left,n=s.clientY-e.top,r=g.geometry.pixelToGrid(t,n);if(c.setHoveredCell(r),r){const a=c.getPlayerAtPosition(r);a?H.show(a,s.clientX,s.clientY):H.hide()}else H.hide()});S.addEventListener("mouseleave",()=>{H.hide(),c.setHoveredCell(null)});function k(){w=[],_=[],A=[],M=[],E=[]}async function Ie(s,e,t){p=!0;try{const n=await y.submitAction(f,"move",{playerId:s,x:e,y:t});await I(n),k()}catch{b.error("Move failed")}finally{p=!1}}async function xe(s,e,t){p=!0;try{const n=await y.submitAction(f,t,{playerId:s,targetId:e});await I(n),k(),v.setSelectedMode(null)}catch{b.error("Block failed")}finally{p=!1}}async function $e(s,e,t){p=!0;try{const n=await y.submitAction(f,"multiple_block",{playerId:s,targetId:e,targetId2:t});await I(n),k(),v.setSelectedMode(null)}catch{b.error("Multiple Block failed")}finally{p=!1}}async function Ae(s,e,t){p=!0;try{const n=await y.submitAction(f,"pass",{playerId:s,targetX:e,targetY:t});await I(n),k(),v.setSelectedMode(null)}catch{b.error("Pass failed")}finally{p=!1}}async function Me(s,e){p=!0;try{const t=await y.submitAction(f,"hand_off",{playerId:s,targetId:e});await I(t),k(),v.setSelectedMode(null)}catch{b.error("Hand-off failed")}finally{p=!1}}async function Ee(s,e){p=!0;try{const t=await y.submitAction(f,"foul",{playerId:s,targetId:e});await I(t),k(),v.setSelectedMode(null)}catch{b.error("Foul failed")}finally{p=!1}}function Ce(s){N=s,j.setSelectedPlayer(s)}async function Le(s,e,t){p=!0;try{const n=await y.submitAction(f,"setup_player",{playerId:s,x:e,y:t});F.addEvents(n.events),c.setGameState(n.state),N=null,j.setSelectedPlayer(null)}catch{b.error("Setup failed")}finally{p=!1}}async function Y(s){const e={toggle_block:"block",toggle_multiple_block:"multiple_block",toggle_blitz:"blitz",toggle_pass:"pass",toggle_handoff:"handoff",toggle_foul:"foul"};if(s in e){const t=e[s],n=v.getSelectedMode();v.setSelectedMode(n===t?null:t),c.clearSelection(),k();const r=c.getGameState();r&&c.setGameState(r);return}if(!p){p=!0;try{const t=await y.submitAction(f,s);await I(t),k(),v.setSelectedMode(null)}catch{b.error("Action failed")}finally{p=!1}}}document.addEventListener("keydown",s=>{const e=c.getGameState();if(!e||p||C.isAnimating||!c.isPlayerTurn())return;const t=s.key.toLowerCase();if((t===" "||t==="enter")&&e.phase==="play"){s.preventDefault(),Y("end_turn");return}if(t==="escape"){s.preventDefault(),c.clearSelection(),k(),v.setSelectedMode(null),e&&c.setGameState(e);return}if(e.phase!=="play")return;const n={b:"block",m:"multiple_block",z:"blitz",p:"pass",h:"handoff",f:"foul"};if(t in n){s.preventDefault();const r=n[t],a=v.getSelectedMode();v.setSelectedMode(a===r?null:r),c.clearSelection(),k(),e&&c.setGameState(e)}});async function He(){try{const s=await y.getAllEvents(f);if(s.length===0)return;V.style.display="",R.setEvents(s),R.setOnStep(e=>{F.addEvents([e])})}catch{b.error("Failed to load replay")}}async function Ne(){const s=c.getGameState();if(!s||s.phase!=="game_over")return;const e=s.players.filter(n=>n.playerId>0).map(n=>n.playerId),t=[...new Set(e)];for(const n of t)try{const r=await y.getAvailableSkills(n);if(!r.can_advance||r.normal.length===0&&r.double.length===0)continue;const a=s.players.find(l=>l.playerId===n),i=(a==null?void 0:a.name)??`Player #${n}`;await new Promise(l=>{Te.show(i,r,async h=>{try{await y.advancePlayer(n,h),b.success(`${i} learned a new skill!`)}catch{b.error("Failed to advance player")}l()},()=>l())})}catch{}}async function Be(){try{const s=await y.getMatchState(f);c.setGameState(s),s.phase==="game_over"&&(He(),Ne())}catch{b.error("Failed to load match state")}}Be();
